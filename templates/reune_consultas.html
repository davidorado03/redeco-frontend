{% extends 'base.html' %}

{% block content %}
<div class="row">
  <div class="col-12">
    <h2 class="mb-4">Envío de Consultas REUNE</h2>

    {% if not token %}
    <div class="alert alert-warning">
      <strong>Token requerido:</strong> Necesitas generar un token desde la <a href="{% url 'redeco_frontend:index' %}">página principal</a> para usar este endpoint.
    </div>
    {% endif %}

    {% if error %}
    <div class="alert alert-danger">
      <h5 class="alert-heading">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-exclamation-triangle-fill me-2" viewBox="0 0 16 16">
          <path d="M8.982 1.566a1.13 1.13 0 0 0-1.96 0L.165 13.233c-.457.778.091 1.767.98 1.767h13.713c.889 0 1.438-.99.98-1.767L8.982 1.566zM8 5c.535 0 .954.462.9.995l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 5.995A.905.905 0 0 1 8 5zm.002 6a1 1 0 1 1 0 2 1 1 0 0 1 0-2z"/>
        </svg>
        Error al enviar consultas
      </h5>
      <p class="mb-0">{{ error }}</p>
      
      {% if '502' in error or '503' in error or '504' in error %}
      <hr>
      <p class="mb-0">
        <strong>Sugerencias:</strong>
      </p>
      <ul class="mb-0">
        <li>Espera unos minutos e intenta nuevamente</li>
        <li>Verifica que la API REUNE esté disponible</li>
        <li>Contacta al soporte de CONDUSEF si el problema persiste</li>
      </ul>
      {% endif %}
      
      {% if '401' in error or 'token' in error|lower or 'expirado' in error|lower %}
      <hr>
      <a href="{% url 'redeco_frontend:index' %}" class="btn btn-sm btn-warning">
        Generar nuevo token
      </a>
      {% endif %}
    </div>
    {% endif %}

    {% if result %}
    <div class="alert alert-success">
      <h5>Respuesta exitosa</h5>
      <pre class="mb-0" style="white-space: pre-wrap; word-wrap: break-word;">{{ result|safe }}</pre>
    </div>
    {% endif %}

    <div class="card">
      <div class="card-header">
        <h5 class="mb-0">Formulario de Envío de Consultas</h5>
      </div>
      <div class="card-body">
        <form method="post">
          {% csrf_token %}
          
          <!-- SECCIÓN 1: INFORMACIÓN DE LA INSTITUCIÓN -->
          <div class="row">
            <div class="col-12 mb-3">
              <h6 class="text-primary border-bottom pb-2">
                <i class="bi bi-building"></i> Información de la Institución
              </h6>
            </div>
          </div>

          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">Denominación o Razón Social <span class="text-danger">*</span></label>
              <input type="text" name="institucion_clave" class="form-control" value="{{ form.institucion_clave }}" maxlength="400" required />
              <small class="form-text text-muted">Copiar de SIPRES/REUNE tal cual aparece (máx. 400 caracteres)</small>
            </div>

            <div class="col-md-6 mb-3">
              <label class="form-label">Sector <span class="text-danger">*</span></label>
              <input type="text" name="sector" class="form-control" value="{{ form.sector }}" maxlength="200" required />
              <small class="form-text text-muted">Copiar de SIPRES/REUNE tal cual aparece (máx. 200 caracteres)</small>
            </div>
          </div>

          <!-- SECCIÓN 2: DATOS DE LA CONSULTA -->
          <div class="row mt-4">
            <div class="col-12 mb-3">
              <h6 class="text-primary border-bottom pb-2">
                <i class="bi bi-file-text"></i> Datos de la Consulta
              </h6>
            </div>
          </div>

          <div class="row">
            <div class="col-md-3 mb-3">
              <label class="form-label">Trimestre <span class="text-danger">*</span></label>
              <select name="consultas_trim" class="form-control" required>
                <option value="">-- Seleccione --</option>
                <option value="1">1 - Enero-Marzo</option>
                <option value="2">2 - Abril-Junio</option>
                <option value="3">3 - Julio-Septiembre</option>
                <option value="4">4 - Octubre-Diciembre</option>
              </select>
            </div>

            <div class="col-md-3 mb-3">
              <label class="form-label">Número de Consultas <span class="text-danger">*</span></label>
              <input type="number" name="num_consultas" class="form-control" value="1" readonly />
              <small class="form-text text-muted">Siempre es 1 según disposición</small>
            </div>

            <div class="col-md-3 mb-3">
              <label class="form-label">Folio <span class="text-danger">*</span></label>
              <input type="text" name="consultas_folio" class="form-control" value="{{ form.consultas_folio }}" maxlength="50" required />
              <small class="form-text text-muted">ÚNICO por institución (máx. 50 caracteres)</small>
            </div>

            <div class="col-md-3 mb-3">
              <label class="form-label">Estatus <span class="text-danger">*</span></label>
              <select name="consultas_estatus_con" class="form-control" required>
                <option value="">-- Seleccione --</option>
                <option value="1">1 - Pendiente</option>
                <option value="2">2 - Concluido</option>
              </select>
            </div>
          </div>

          <div class="row">
            <div class="col-md-4 mb-3" id="fecha_aten_field">
              <label class="form-label">Fecha de Atención <span class="text-danger" id="fecha_aten_required">*</span></label>
              <input type="date" id="consultas_fec_aten" name="consultas_fec_aten" class="form-control" value="{{ form.consultas_fec_aten }}" />
              <small class="form-text text-muted">Requerida solo si Estatus = Concluido (≥ Fecha Recepción)</small>
            </div>

            <div class="col-md-4 mb-3">
              <label class="form-label">Fecha de Consulta <span class="text-danger">*</span></label>
              <input type="date" name="consultas_fec_recepcion" class="form-control" value="{{ form.consultas_fec_recepcion }}" required />
              <small class="form-text text-muted">Debe estar dentro del trimestre a reportar</small>
            </div>

            <div class="col-md-4 mb-3">
              <label class="form-label">PORI <span class="text-danger">*</span></label>
              <select name="consultas_pori" class="form-control" required>
                <option value="">-- Seleccione --</option>
                <option value="SI">SI</option>
                <option value="NO">NO</option>
              </select>
            </div>
          </div>

          <!-- SECCIÓN 3: PRODUCTO Y CAUSA -->
          <div class="row mt-4">
            <div class="col-12 mb-3">
              <h6 class="text-primary border-bottom pb-2">
                <i class="bi bi-tag"></i> Producto y Causa
              </h6>
            </div>
          </div>

          <div class="row">
            <div class="col-md-4 mb-3">
              <label class="form-label">Medio de Recepción <span class="text-danger">*</span></label>
              <select name="medios_id" class="form-control" required>
                <option value="">-- Seleccione --</option>
                {% for m in medios %}
                <option value="{{ m.medioId }}">{{ m.medioDsc }}</option>
                {% endfor %}
              </select>
            </div>

            <div class="col-md-4 mb-3" id="nivel_aten_field">
              <label class="form-label">Nivel de Atención <span class="text-danger" id="nivel_aten_required">*</span></label>
              <select id="consultas_cat_nivel_aten_id" name="consultas_cat_nivel_aten_id" class="form-control">
                <option value="">-- Seleccione --</option>
                {% for n in niveles %}
                <option value="{{ n.nivelDeAtencionId }}">{{ n.nivelDeAtencionDsc }}</option>
                {% endfor %}
              </select>
              <small class="form-text text-muted">Requerido solo si Estatus = Concluido</small>
            </div>

            <div class="col-md-4 mb-3">
              <label class="form-label">Producto y/o Servicio <span class="text-danger">*</span></label>
              <input type="text" name="producto" class="form-control" value="{{ form.producto }}" maxlength="12" required />
              <small class="form-text text-muted">Código del catálogo REUNE (máx. 12 caracteres)</small>
            </div>
          </div>

          <div class="row">
            <div class="col-md-12 mb-3">
              <label class="form-label">Causa o Motivo <span class="text-danger">*</span></label>
              <input type="text" name="causa_id" class="form-control" value="{{ form.causa_id }}" maxlength="4" required />
              <small class="form-text text-muted">Código del catálogo REUNE (máx. 4 caracteres)</small>
            </div>
          </div>

          <!-- SECCIÓN 4: UBICACIÓN GEOGRÁFICA -->
          <div class="row mt-4">
            <div class="col-12 mb-3">
              <h6 class="text-primary border-bottom pb-2">
                <i class="bi bi-geo-alt"></i> Ubicación Geográfica
              </h6>
            </div>
          </div>

          <div class="row">
            <div class="col-md-3 mb-3">
              <label class="form-label">Estado <span class="text-danger">*</span></label>
              <select name="estados_id" class="form-control" required>
                <option value="">-- Seleccione --</option>
                {% for e in estados %}
                <option value="{{ e.claveEdo }}">{{ e.estado }}</option>
                {% endfor %}
              </select>
            </div>

            <div class="col-md-3 mb-3" id="cp_field">
              <label class="form-label">Código Postal <span class="text-danger" id="cp_required">*</span></label>
              <input type="text" id="consultas_cp" name="consultas_cp" class="form-control" maxlength="5" pattern="[0-9]{5}" value="{{ form.consultas_cp }}" />
              <small class="form-text text-muted">Requerido si medio = UNE/Sucursal/Oficina</small>
            </div>

            <div class="col-md-3 mb-3">
              <label class="form-label">Municipio ID <span class="text-danger">*</span></label>
              <input type="number" name="consultas_mpio_id" class="form-control" value="{{ form.consultas_mpio_id }}" required />
            </div>

            <div class="col-md-3 mb-3">
              <label class="form-label">Localidad ID</label>
              <input type="number" name="consultas_loc_id" class="form-control" value="{{ form.consultas_loc_id }}" />
              <small class="form-text text-muted">Opcional - Catálogo REUNE</small>
            </div>
          </div>

          <div class="row">
            <div class="col-md-12 mb-3">
              <label class="form-label">Colonia ID</label>
              <input type="number" name="consultas_col_id" class="form-control" value="{{ form.consultas_col_id }}" />
              <small class="form-text text-muted">Opcional - Catálogo REUNE</small>
            </div>
          </div>

          <div class="d-flex gap-2 mt-4">
            <button type="submit" class="btn btn-primary" {% if not token %}disabled{% endif %}>
              <i class="bi bi-send"></i> Enviar Consulta
            </button>
            <a href="{% url 'redeco_frontend:index' %}" class="btn btn-secondary">
              <i class="bi bi-arrow-left"></i> Volver al inicio
            </a>
          </div>
        </form>
      </div>
    </div>

    {% if result %}
    <div class="card mt-4">
      <div class="card-header">
        <h5 class="mb-0">Detalle de la Respuesta</h5>
      </div>
      <div class="card-body">
        {% if result.message %}
        <p><strong>Mensaje:</strong> {{ result.message }}</p>
        {% endif %}
        
        {% if result.errors %}
        <h6 class="text-danger">Errores por folio:</h6>
        <div class="table-responsive">
          <table class="table table-sm table-bordered">
            <thead>
              <tr>
                <th>Folio</th>
                <th>Errores</th>
              </tr>
            </thead>
            <tbody>
              {% for folio, errors in result.errors.items %}
              <tr>
                <td><strong>{{ folio }}</strong></td>
                <td>
                  <ul class="mb-0">
                    {% for error_msg in errors %}
                    <li>{{ error_msg }}</li>
                    {% endfor %}
                  </ul>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        {% endif %}

        {% if result|length > 0 and not result.errors %}
        <div class="alert alert-info">
          <strong>Campos adicionales en la respuesta:</strong>
          <ul class="mb-0">
            {% for key, value in result.items %}
            {% if key != 'message' %}
            <li><strong>{{ key }}:</strong> {{ value }}</li>
            {% endif %}
            {% endfor %}
          </ul>
        </div>
        {% endif %}
      </div>
    </div>
    {% endif %}
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const estatusSelect = document.querySelector('select[name="consultas_estatus_con"]');
  const fechaAtenField = document.getElementById('fecha_aten_field');
  const fechaAtenInput = document.getElementById('consultas_fec_aten');
  const fechaAtenRequired = document.getElementById('fecha_aten_required');
  const nivelAtenField = document.getElementById('nivel_aten_field');
  const nivelAtenSelect = document.getElementById('consultas_cat_nivel_aten_id');
  const nivelAtenRequired = document.getElementById('nivel_aten_required');
  const medioSelect = document.querySelector('select[name="medios_id"]');
  const cpField = document.getElementById('cp_field');
  const cpInput = document.getElementById('consultas_cp');
  const cpRequired = document.getElementById('cp_required');

  // Manejar campos condicionales según estatus
  function updateConditionalFields() {
    const estatus = estatusSelect.value;
    const isConcluido = estatus === '2';

    if (isConcluido) {
      // Estatus = Concluido: Fecha Atención y Nivel son requeridos
      fechaAtenInput.required = true;
      fechaAtenRequired.style.display = '';
      nivelAtenSelect.required = true;
      nivelAtenRequired.style.display = '';
    } else {
      // Estatus = Pendiente: Fecha Atención y Nivel son opcionales
      fechaAtenInput.required = false;
      fechaAtenRequired.style.display = 'none';
      nivelAtenSelect.required = false;
      nivelAtenRequired.style.display = 'none';
    }
  }

  // Manejar CP condicional según medio de recepción
  function updateCPField() {
    const medioId = medioSelect.value;
    // Según REUNE: CP requerido para UNE (1), Sucursal (2), Oficina (4)
    const requiereCP = ['1', '2', '4'].includes(medioId);

    if (requiereCP) {
      cpInput.required = true;
      cpRequired.style.display = '';
    } else {
      cpInput.required = false;
      cpRequired.style.display = 'none';
    }
  }

  // Eventos
  if (estatusSelect) {
    estatusSelect.addEventListener('change', updateConditionalFields);
    updateConditionalFields(); // Inicializar
  }

  if (medioSelect) {
    medioSelect.addEventListener('change', updateCPField);
    updateCPField(); // Inicializar
  }
});
</script>
{% endblock %}
