{% extends 'base.html' %}

{% block content %}
<div class="row">
	<div class="col-md-10 offset-md-1">
		<div class="card shadow-sm mt-4">
			<div class="card-header d-flex justify-content-between align-items-center">
				<h5 class="text-white mb-0">{% if edit_mode %}Editar{% else %}Crear{% endif %} Cliente</h5>
				<a href="{% url 'redeco_frontend:clientes_list' %}" class="btn btn-sm btn-light">
					<i class="bi bi-arrow-left-circle"></i> Volver
				</a>
			</div>
			<div class="card-body">
				{% if error %}
				<div class="alert alert-danger alert-dismissible fade show">
					{{ error }}
					<button type="button" class="btn-close" data-bs-dismiss="alert"></button>
				</div>
				{% endif %}

				{% if success %}
				<div class="alert alert-success alert-dismissible fade show">
					{{ success }}
					<button type="button" class="btn-close" data-bs-dismiss="alert"></button>
				</div>
				{% endif %}

				<form method="post" id="clienteForm" 
                    data-edit-mode="{% if edit_mode %}true{% else %}false{% endif %}"
                    data-municipio-id="{% if edit_mode %}{{ cliente.municipio_id }}{% endif %}"
                    data-colonia-id="{% if edit_mode %}{{ cliente.colonia_id }}{% endif %}"
                    data-codigo-postal="{% if edit_mode %}{{ cliente.codigo_postal }}{% endif %}">
					{% csrf_token %}
					<div class="row">
						<!-- Datos principales -->
						<div class="col-md-6 mb-3">
							<label class="form-label">Nombre del cliente <span class="text-danger">*</span></label>
							<input type="text" name="nombre" class="form-control" 
								value="{% if edit_mode %}{{ cliente.nombre }}{% else %}{{ form.nombre }}{% endif %}" 
								required maxlength="255" />
						</div>

						<div class="col-md-6 mb-3">
							<label class="form-label">RFC <span class="text-danger">*</span></label>
							<input type="text" name="rfc" class="form-control" 
								value="{% if edit_mode %}{{ cliente.rfc }}{% else %}{{ form.rfc }}{% endif %}" 
								required maxlength="13" pattern="[A-Z&Ñ]{3,4}[0-9]{6}[A-Z0-9]{3}" 
								style="text-transform:uppercase;" />
							<small class="form-text text-muted">Formato: XAXX010101000 (12-13 caracteres)</small>
						</div>

						<div class="col-md-6 mb-3">
							<label class="form-label">Tipo de persona <span class="text-danger">*</span></label>
							<select name="tipo_persona" id="tipo_persona" class="form-control" required>
								<option value="">-- Seleccione --</option>
								<option value="1" {% if edit_mode and cliente.tipo_persona == 1 %}selected{% elif form.tipo_persona == '1' %}selected{% endif %}>Persona Física</option>
								<option value="2" {% if edit_mode and cliente.tipo_persona == 2 %}selected{% elif form.tipo_persona == '2' %}selected{% endif %}>Persona Moral</option>
							</select>
						</div>

						<!-- Datos geográficos -->
						<div class="col-md-6 mb-3">
							<label class="form-label">Estado <span class="text-danger">*</span></label>
							<select id="estado_select" name="estado_id" class="form-control" required>
								<option value="">-- Seleccione --</option>
								<option value="1" data-nombre="Aguascalientes" {% if edit_mode and cliente.estado_id == 1 %}selected{% elif form.estado_id == '1' %}selected{% endif %}>Aguascalientes</option>
								<option value="2" data-nombre="Baja California" {% if edit_mode and cliente.estado_id == 2 %}selected{% elif form.estado_id == '2' %}selected{% endif %}>Baja California</option>
								<option value="3" data-nombre="Baja California Sur" {% if edit_mode and cliente.estado_id == 3 %}selected{% elif form.estado_id == '3' %}selected{% endif %}>Baja California Sur</option>
								<option value="4" data-nombre="Campeche" {% if edit_mode and cliente.estado_id == 4 %}selected{% elif form.estado_id == '4' %}selected{% endif %}>Campeche</option>
								<option value="5" data-nombre="Coahuila de Zaragoza" {% if edit_mode and cliente.estado_id == 5 %}selected{% elif form.estado_id == '5' %}selected{% endif %}>Coahuila de Zaragoza</option>
								<option value="6" data-nombre="Colima" {% if edit_mode and cliente.estado_id == 6 %}selected{% elif form.estado_id == '6' %}selected{% endif %}>Colima</option>
								<option value="7" data-nombre="Chiapas" {% if edit_mode and cliente.estado_id == 7 %}selected{% elif form.estado_id == '7' %}selected{% endif %}>Chiapas</option>
								<option value="8" data-nombre="Chihuahua" {% if edit_mode and cliente.estado_id == 8 %}selected{% elif form.estado_id == '8' %}selected{% endif %}>Chihuahua</option>
								<option value="9" data-nombre="Ciudad de México" {% if edit_mode and cliente.estado_id == 9 %}selected{% elif form.estado_id == '9' %}selected{% endif %}>Ciudad de México</option>
								<option value="10" data-nombre="Durango" {% if edit_mode and cliente.estado_id == 10 %}selected{% elif form.estado_id == '10' %}selected{% endif %}>Durango</option>
								<option value="11" data-nombre="Guanajuato" {% if edit_mode and cliente.estado_id == 11 %}selected{% elif form.estado_id == '11' %}selected{% endif %}>Guanajuato</option>
								<option value="12" data-nombre="Guerrero" {% if edit_mode and cliente.estado_id == 12 %}selected{% elif form.estado_id == '12' %}selected{% endif %}>Guerrero</option>
								<option value="13" data-nombre="Hidalgo" {% if edit_mode and cliente.estado_id == 13 %}selected{% elif form.estado_id == '13' %}selected{% endif %}>Hidalgo</option>
								<option value="14" data-nombre="Jalisco" {% if edit_mode and cliente.estado_id == 14 %}selected{% elif form.estado_id == '14' %}selected{% endif %}>Jalisco</option>
								<option value="15" data-nombre="México" {% if edit_mode and cliente.estado_id == 15 %}selected{% elif form.estado_id == '15' %}selected{% endif %}>México</option>
								<option value="16" data-nombre="Michoacán de Ocampo" {% if edit_mode and cliente.estado_id == 16 %}selected{% elif form.estado_id == '16' %}selected{% endif %}>Michoacán de Ocampo</option>
								<option value="17" data-nombre="Morelos" {% if edit_mode and cliente.estado_id == 17 %}selected{% elif form.estado_id == '17' %}selected{% endif %}>Morelos</option>
								<option value="18" data-nombre="Nayarit" {% if edit_mode and cliente.estado_id == 18 %}selected{% elif form.estado_id == '18' %}selected{% endif %}>Nayarit</option>
								<option value="19" data-nombre="Nuevo León" {% if edit_mode and cliente.estado_id == 19 %}selected{% elif form.estado_id == '19' %}selected{% endif %}>Nuevo León</option>
								<option value="20" data-nombre="Oaxaca" {% if edit_mode and cliente.estado_id == 20 %}selected{% elif form.estado_id == '20' %}selected{% endif %}>Oaxaca</option>
								<option value="21" data-nombre="Puebla" {% if edit_mode and cliente.estado_id == 21 %}selected{% elif form.estado_id == '21' %}selected{% endif %}>Puebla</option>
								<option value="22" data-nombre="Querétaro" {% if edit_mode and cliente.estado_id == 22 %}selected{% elif form.estado_id == '22' %}selected{% endif %}>Querétaro</option>
								<option value="23" data-nombre="Quintana Roo" {% if edit_mode and cliente.estado_id == 23 %}selected{% elif form.estado_id == '23' %}selected{% endif %}>Quintana Roo</option>
								<option value="24" data-nombre="San Luis Potosí" {% if edit_mode and cliente.estado_id == 24 %}selected{% elif form.estado_id == '24' %}selected{% endif %}>San Luis Potosí</option>
								<option value="25" data-nombre="Sinaloa" {% if edit_mode and cliente.estado_id == 25 %}selected{% elif form.estado_id == '25' %}selected{% endif %}>Sinaloa</option>
								<option value="26" data-nombre="Sonora" {% if edit_mode and cliente.estado_id == 26 %}selected{% elif form.estado_id == '26' %}selected{% endif %}>Sonora</option>
								<option value="27" data-nombre="Tabasco" {% if edit_mode and cliente.estado_id == 27 %}selected{% elif form.estado_id == '27' %}selected{% endif %}>Tabasco</option>
								<option value="28" data-nombre="Tamaulipas" {% if edit_mode and cliente.estado_id == 28 %}selected{% elif form.estado_id == '28' %}selected{% endif %}>Tamaulipas</option>
								<option value="29" data-nombre="Tlaxcala" {% if edit_mode and cliente.estado_id == 29 %}selected{% elif form.estado_id == '29' %}selected{% endif %}>Tlaxcala</option>
								<option value="30" data-nombre="Veracruz de Ignacio de la Llave" {% if edit_mode and cliente.estado_id == 30 %}selected{% elif form.estado_id == '30' %}selected{% endif %}>Veracruz de Ignacio de la Llave</option>
								<option value="31" data-nombre="Yucatán" {% if edit_mode and cliente.estado_id == 31 %}selected{% elif form.estado_id == '31' %}selected{% endif %}>Yucatán</option>
								<option value="32" data-nombre="Zacatecas" {% if edit_mode and cliente.estado_id == 32 %}selected{% elif form.estado_id == '32' %}selected{% endif %}>Zacatecas</option>
							</select>
							<input type="hidden" name="estado_nombre" id="estado_nombre" 
								value="{% if edit_mode %}{{ cliente.estado_nombre }}{% else %}{{ form.estado_nombre }}{% endif %}" />
						</div>

						<div class="col-md-6 mb-3">
							<label class="form-label">Código Postal <span class="text-danger">*</span></label>
							<input type="text" id="cp_input" name="codigo_postal" class="form-control" 
								value="{% if edit_mode %}{{ cliente.codigo_postal }}{% else %}{{ form.codigo_postal }}{% endif %}" 
								required maxlength="5" pattern="[0-9]{5}" />
						</div>

						<div class="col-md-6 mb-3">
							<label class="form-label">Municipio</label>
							<select id="municipio_select" name="municipio_id" class="form-control" disabled>
								<option value="">-- Ingrese CP primero --</option>
							</select>
							<input type="hidden" name="municipio_nombre" id="municipio_nombre" 
								value="{% if edit_mode %}{{ cliente.municipio_nombre }}{% else %}{{ form.municipio_nombre }}{% endif %}" />
						</div>

						<div class="col-md-6 mb-3">
							<label class="form-label">Colonia</label>
							<select id="colonia_select" name="colonia_id" class="form-control" disabled>
								<option value="">-- Ingrese CP primero --</option>
							</select>
							<input type="hidden" name="colonia_nombre" id="colonia_nombre" 
								value="{% if edit_mode %}{{ cliente.colonia_nombre }}{% else %}{{ form.colonia_nombre }}{% endif %}" />
						</div>

						<div class="col-md-6 mb-3">
							<label class="form-label">Localidad</label>
							<input type="text" name="localidad" class="form-control" 
								value="{% if edit_mode %}{{ cliente.localidad }}{% else %}{{ form.localidad }}{% endif %}" 
								maxlength="8" />
						</div>

						<!-- Campos solo para persona física -->
						<div class="col-md-6 mb-3" id="sexo_field">
							<label class="form-label">Sexo</label>
							<select name="sexo" class="form-control">
								<option value="">-- Seleccione --</option>
								<option value="H" {% if edit_mode and cliente.sexo == 'H' %}selected{% elif form.sexo == 'H' %}selected{% endif %}>Hombre</option>
								<option value="M" {% if edit_mode and cliente.sexo == 'M' %}selected{% elif form.sexo == 'M' %}selected{% endif %}>Mujer</option>
							</select>
							<small class="form-text text-muted">Solo para persona física</small>
						</div>

						<div class="col-md-6 mb-3" id="edad_field">
							<label class="form-label">Edad</label>
							<input type="number" name="edad" class="form-control" 
                                value="{% if edit_mode %}{{ cliente.edad }}{% else %}{{ form.edad }}{% endif %}" 
                                min="0" max="999" />
							<small class="form-text text-muted">Solo para persona física (máx. 3 dígitos)</small>
						</div>
					</div>

					<div class="d-flex gap-2 mt-3">
						<button type="submit" class="btn btn-primary">
							{% if edit_mode %}Actualizar{% else %}Crear{% endif %} Cliente
						</button>
						<button type="button" class="btn btn-secondary" onclick="confirmarCancelacion()">Cancelar</button>
					</div>
				</form>
			</div>
		</div>
	</div>
</div>

<script>
function confirmarCancelacion() {
	if (confirm('¿Estás seguro de que deseas cancelar? Se perderán los cambios no guardados.')) {
		window.location.href = "{% url 'redeco_frontend:clientes_list' %}";
	}
}

(function() {
	const API_BASE = 'https://api.condusef.gob.mx';
	const form = document.getElementById('clienteForm');
	const editMode = form.dataset.editMode === 'true';
	const editData = {
		municipioId: form.dataset.municipioId || '',
		coloniaId: form.dataset.coloniaId || '',
		codigoPostal: form.dataset.codigoPostal || ''
	};
	
	const estadoSelect = document.getElementById('estado_select');
	const cpInput = document.getElementById('cp_input');
	const municipioSelect = document.getElementById('municipio_select');
	const coloniaSelect = document.getElementById('colonia_select');
	const tipoPersonaSelect = document.getElementById('tipo_persona');
	const sexoField = document.getElementById('sexo_field');
	const edadField = document.getElementById('edad_field');
	
	// Guardar nombre del estado seleccionado
	estadoSelect.addEventListener('change', function() {
		const selectedOption = this.options[this.selectedIndex];
		document.getElementById('estado_nombre').value = selectedOption.getAttribute('data-nombre') || '';
	});
	
	// Mostrar/ocultar campos según tipo de persona
	function togglePersonaFields() {
		const tipoPersona = tipoPersonaSelect.value;
		if (tipoPersona === '2') {
			// Persona Moral - ocultar sexo y edad
			sexoField.style.display = 'none';
			edadField.style.display = 'none';
			document.querySelector('select[name="sexo"]').value = '';
			document.querySelector('input[name="edad"]').value = '';
		} else {
			// Persona Física - mostrar sexo y edad
			sexoField.style.display = 'block';
			edadField.style.display = 'block';
		}
	}
	
	tipoPersonaSelect.addEventListener('change', togglePersonaFields);
	togglePersonaFields(); // Ejecutar al cargar
	
	// Cargar municipios y colonias cuando se ingresa un CP válido
	cpInput.addEventListener('input', function() {
		const cp = this.value.trim();
		
		municipioSelect.innerHTML = '<option value="">-- Ingrese CP primero --</option>';
		municipioSelect.disabled = true;
		coloniaSelect.innerHTML = '<option value="">-- Ingrese CP primero --</option>';
		coloniaSelect.disabled = true;
		
		if (cp.length !== 5 || !/^\d{5}$/.test(cp)) {
			return;
		}
		
		municipioSelect.innerHTML = '<option value="">-- Cargando... --</option>';
		coloniaSelect.innerHTML = '<option value="">-- Cargando... --</option>';
		
		loadMunicipios(cp);
		loadColonias(cp);
	});
	
	async function loadMunicipios(cp) {
		try {
			if (!estadoSelect.value) {
				municipioSelect.innerHTML = '<option value="">Seleccione estado primero</option>';
				return;
			}
			const url = `${API_BASE}/sepomex/municipios/?estado_id=${encodeURIComponent(estadoSelect.value)}&cp=${encodeURIComponent(cp)}`;
			const response = await fetch(url);
			if (!response.ok) throw new Error('Error al cargar municipios');
			
			const data = await response.json();
			municipioSelect.innerHTML = '<option value="">-- Seleccione Municipio --</option>';
			
			let municipios = data.municipios || data || [];
			
			municipios.forEach(mun => {
				const option = document.createElement('option');
				const text = mun.nombre || mun.municipio || mun.name || '';
				option.value = mun.municipioId || mun.municipio_id || mun.id || '';
				option.textContent = text;
				option.setAttribute('data-nombre', text);
				municipioSelect.appendChild(option);
			});
			
			municipioSelect.disabled = false;
			
			if (editMode && editData.municipioId) {
				municipioSelect.value = editData.municipioId;
			}
		} catch (error) {
			console.error('Error cargando municipios:', error);
			municipioSelect.innerHTML = '<option value="">Error al cargar municipios</option>';
		}
	}
	
	async function loadColonias(cp) {
		try {
			const response = await fetch(`${API_BASE}/sepomex/colonias/?cp=${cp}`);
			if (!response.ok) throw new Error('Error al cargar colonias');
			
			const data = await response.json();
			coloniaSelect.innerHTML = '<option value="">-- Seleccione Colonia --</option>';
			
			let colonias = data.colonias || data || [];
			
			colonias.forEach(col => {
				const option = document.createElement('option');
				const text = col.colonia || col.nombre || col.name || '';
				option.value = col.coloniaId || col.colonia_id || col.id || '';
				option.textContent = text;
				option.setAttribute('data-nombre', text);
				coloniaSelect.appendChild(option);
			});
			
			coloniaSelect.disabled = false;
			
			if (editMode && editData.coloniaId) {
				coloniaSelect.value = editData.coloniaId;
			}
		} catch (error) {
			console.error('Error cargando colonias:', error);
			coloniaSelect.innerHTML = '<option value="">Error al cargar colonias</option>';
		}
	}
	
	// Guardar nombres de municipio y colonia seleccionados
	municipioSelect.addEventListener('change', function() {
		const selectedOption = this.options[this.selectedIndex];
		document.getElementById('municipio_nombre').value = selectedOption.getAttribute('data-nombre') || '';
	});
	
	coloniaSelect.addEventListener('change', function() {
		const selectedOption = this.options[this.selectedIndex];
		document.getElementById('colonia_nombre').value = selectedOption.getAttribute('data-nombre') || '';
	});
	
	// Si estamos en modo edición y hay CP, cargar datos
	if (editMode && editData.codigoPostal && editData.codigoPostal.length === 5) {
		loadMunicipios(editData.codigoPostal);
		loadColonias(editData.codigoPostal);
	}
})();
</script>
{% endblock %}
