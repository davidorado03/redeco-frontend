{% extends 'base.html' %}

{% block content %}
<!-- Alertas flotantes -->
<div class="position-fixed top-0 end-0 p-3" style="z-index: 1050;">
	{% if create_success %}
	<div class="toast show align-items-center text-white bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true" data-bs-autohide="true" data-bs-delay="3000">
		<div class="d-flex">
			<div class="toast-body">
				<i class="bi bi-check-circle-fill me-2"></i>{{ create_success }}
			</div>
			<button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
		</div>
	</div>
	{% endif %}

	{% if update_success %}
	<div class="toast show align-items-center text-white bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true" data-bs-autohide="true" data-bs-delay="3000">
		<div class="d-flex">
			<div class="toast-body">
				<i class="bi bi-check-circle-fill me-2"></i>{{ update_success }}
			</div>
			<button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
		</div>
	</div>
	{% endif %}

	{% if delete_success %}
	<div class="toast show align-items-center text-white bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true" data-bs-autohide="true" data-bs-delay="3000">
		<div class="d-flex">
			<div class="toast-body">
				<i class="bi bi-check-circle-fill me-2"></i>{{ delete_success }}
			</div>
			<button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
		</div>
	</div>
	{% endif %}

	{% if delete_error %}
	<div class="toast show align-items-center text-white bg-danger border-0" role="alert" aria-live="assertive" aria-atomic="true" data-bs-autohide="true" data-bs-delay="4000">
		<div class="d-flex">
			<div class="toast-body">
				<i class="bi bi-exclamation-triangle-fill me-2"></i>{{ delete_error }}
			</div>
			<button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
		</div>
	</div>
	{% endif %}
</div>

<div class="row">
	<div class="col-12">
		<div class="card shadow-sm mt-4">
			<div class="card-header d-flex justify-content-between align-items-center">
				<h5 class="text-white mb-0">Catálogo de Clientes</h5>
				<a href="{% url 'redeco_frontend:clientes_create' %}" class="btn btn-sm btn-light">
					<i class="bi bi-plus-circle"></i> Nuevo Cliente
				</a>
			</div>
			<div class="card-body">

				<!-- Filtros y Ordenamiento -->
				<form method="get" class="mb-4">
					<div class="row g-3">
						<div class="col-md-2">
							<label class="form-label">Ordenar por ID</label>
							<select name="order_by" class="form-select form-select-sm">
								<option value="-id" {% if order_by == '-id' %}selected{% endif %}>Descendente (nuevo primero)</option>
								<option value="id" {% if order_by == 'id' %}selected{% endif %}>Ascendente (viejo primero)</option>
							</select>
						</div>
						<div class="col-md-2">
							<label class="form-label">RFC</label>
							<input type="text" name="rfc" class="form-control form-control-sm" placeholder="Buscar RFC..." value="{{ rfc_filter }}">
						</div>
						<div class="col-md-2">
							<label class="form-label">Tipo</label>
							<select name="tipo" class="form-select form-select-sm">
								<option value="">Todos</option>
								<option value="1" {% if tipo_filter == '1' %}selected{% endif %}>Física</option>
								<option value="2" {% if tipo_filter == '2' %}selected{% endif %}>Moral</option>
							</select>
						</div>
						<div class="col-md-2">
							<label class="form-label">Estado</label>
							<select name="estado" class="form-select form-select-sm">
								<option value="">Todos</option>
								{% for estado in estados_disponibles %}
								<option value="{{ estado.estado_id }}" {% if estado_filter == estado.estado_id|stringformat:"s" %}selected{% endif %}>
									{{ estado.estado_nombre }}
								</option>
								{% endfor %}
							</select>
						</div>
						<div class="col-md-2">
							<label class="form-label">CP</label>
							<input type="text" name="cp" class="form-control form-control-sm" placeholder="Código Postal..." value="{{ cp_filter }}" maxlength="5">
						</div>
						<div class="col-md-2">
							<label class="form-label">Municipio</label>
							<select name="municipio" class="form-select form-select-sm">
								<option value="">Todos</option>
								{% for municipio in municipios_disponibles %}
								<option value="{{ municipio.municipio_id }}" {% if municipio_filter == municipio.municipio_id|stringformat:"s" %}selected{% endif %}>
									{{ municipio.municipio_nombre }}
								</option>
								{% endfor %}
							</select>
						</div>
					</div>
					<div class="mt-3">
						<button type="submit" class="btn btn-primary btn-sm">
							<i class="bi bi-funnel"></i> Aplicar Filtros
						</button>
						<a href="{% url 'redeco_frontend:clientes_list' %}" class="btn btn-secondary btn-sm">
							<i class="bi bi-x-circle"></i> Limpiar
						</a>
					</div>
				</form>

				<hr>

				{% if clientes %}
				<div class="table-responsive">
					<table class="table table-hover table-striped">
						<thead class="table-dark">
							<tr>
								<th>ID</th>
								<th>Nombre</th>
								<th>RFC</th>
								<th>Tipo</th>
								<th>Estado</th>
								<th>CP</th>
								<th>Municipio</th>
								<th>Colonia</th>
								<th>Sexo</th>
								<th>Edad</th>
								<th>Acciones</th>
							</tr>
						</thead>
						<tbody>
							{% for cliente in clientes %}
							<tr>
								<td>{{ cliente.id }}</td>
								<td>{{ cliente.nombre }}</td>
								<td>{{ cliente.rfc }}</td>
								<td>
									{% if cliente.tipo_persona == 1 %}
										<span class="badge bg-info">Física</span>
									{% else %}
										<span class="badge bg-secondary">Moral</span>
									{% endif %}
								</td>
								<td>{{ cliente.estado_nombre|default:cliente.estado_id }}</td>
								<td>{{ cliente.codigo_postal }}</td>
								<td>{{ cliente.municipio_nombre|default:cliente.municipio_id|default:'-' }}</td>
								<td>{{ cliente.colonia_nombre|default:cliente.colonia_id|default:'-' }}</td>
								<td>{{ cliente.sexo|default:'-' }}</td>
								<td>{{ cliente.edad|default:'-' }}</td>
								<td>
									<div class="d-flex gap-1">
										<a href="{% url 'redeco_frontend:clientes_edit' cliente.id %}" 
										    class="btn btn-sm btn-warning" title="Editar cliente">
											<i class="bi bi-pencil-square"></i> Editar
										</a>
										<button type="button" class="btn btn-sm btn-danger" 
												data-bs-toggle="modal" 
												data-bs-target="#deleteModal{{ cliente.id }}" 
												title="Eliminar cliente">
											<i class="bi bi-trash3"></i> Borrar
										</button>
									</div>

									<!-- Modal de confirmación de eliminación -->
									<div class="modal fade" id="deleteModal{{ cliente.id }}" tabindex="-1">
										<div class="modal-dialog">
											<div class="modal-content">
												<div class="modal-header">
													<h5 class="modal-title">Confirmar eliminación</h5>
													<button type="button" class="btn-close" data-bs-dismiss="modal"></button>
												</div>
												<div class="modal-body">
													¿Estás seguro de que deseas eliminar al cliente <strong>{{ cliente.nombre }}</strong> ({{ cliente.rfc }})?
												</div>
												<div class="modal-footer">
													<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
													<form method="post" action="{% url 'redeco_frontend:clientes_delete' cliente.id %}" style="display:inline;">
														{% csrf_token %}
														<button type="submit" class="btn btn-danger">Eliminar</button>
													</form>
												</div>
											</div>
										</div>
									</div>
								</td>
							</tr>
							{% endfor %}
						</tbody>
					</table>
				</div>
				{% else %}
				<div class="alert alert-warning">
					<i class="bi bi-search"></i> No se encontraron clientes con los filtros aplicados. 
					<a href="{% url 'redeco_frontend:clientes_list' %}" class="alert-link">Limpiar filtros</a>
					{% if not rfc_filter and not tipo_filter and not estado_filter and not cp_filter and not municipio_filter %}
					o <a href="{% url 'redeco_frontend:clientes_create' %}" class="alert-link">crear el primero</a>
					{% endif %}
				</div>
				{% endif %}
				<div class="mt-3">
					<a href="{% url 'redeco_frontend:index' %}" class="btn btn-secondary">Volver al Dashboard</a>
				</div>
			</div>
		</div>
	</div>
</div>

<script>
// Auto-hide toasts after the specified delay
document.addEventListener('DOMContentLoaded', function() {
	var toastElList = [].slice.call(document.querySelectorAll('.toast'));
	toastElList.forEach(function(toastEl) {
		var toast = new bootstrap.Toast(toastEl);
		setTimeout(function() {
			toast.hide();
		}, parseInt(toastEl.dataset.bsDelay) || 3000);
	});
});
</script>
{% endblock %}
